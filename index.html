<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Markdown2PDF Pro</title>
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- KaTeX CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<!-- DOMPurify -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.11/dist/purify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@hpcc-js/wasm@2.15.0/dist/graphviz.umd.min.js"></script>
<style>
/* ==================== –¢–ï–ú–ê ==================== */
:root {
  /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
  --bg-primary: #1a1f2b;
  --bg-secondary: #222837;
  --bg-panel: #252b3a;
  --bg-toolbar: #2d3445;
  --border-color: #3a4154;
  --text-primary: #e6e9f0;
  --text-secondary: #a0a8bc;
  --accent-color: #4d9de0;
  --accent-hover: #3a85c9;
  --preview-bg: #ffffff;
  --preview-text: #1a1f2b;
  --modal-bg: #1e2433;
  --modal-border: #353d4e;
  --code-bg: #f8f9fa;
  --code-border: #e9ecef;
  --success-color: #10b981;
  --error-color: #ef4444;
  --warning-color: #f59e0b;
  --quote-color: #a0a8bc;
  --stats-bg: #2a3141;
  --stats-text: #b0b8cc;
  --dot-bg: #f8f9fa;
  --dot-border: #dee2e6;
  --dot-text: #495057;
  --dot-note-bg: #e3f2fd;
  --dot-note-text: #1565c0;
  --scrollbar-thumb: #3a4154;
  --scrollbar-thumb-hover: #4a5265;
  --notification-shadow: 0 4px 12px rgba(0,0,0,0.25);
  --panel-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
  --modal-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
  --button-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  --input-bg: #2a3141;
  --input-border: #3a4154;
  --input-focus: #4d9de0;
  --table-header-bg: #f6f8fa;
  --table-border: #999999;
  --page-break-color: #aaa;
  --theme-icon: #ffc107;
}

:root[data-theme="light"] {
  --bg-primary: #f8f9fa;
  --bg-secondary: #e9ecef;
  --bg-panel: #ffffff;
  --bg-toolbar: #f1f3f5;
  --border-color: #dee2e6;
  --text-primary: #212529;
  --text-secondary: #495057;
  --accent-color: #2c7be5;
  --accent-hover: #2463c2;
  --preview-bg: #ffffff;
  --preview-text: #212529;
  --modal-bg: #ffffff;
  --modal-border: #dee2e6;
  --code-bg: #f8f9fa;
  --code-border: #dee2e6;
  --success-color: #10b981;
  --error-color: #ef4444;
  --warning-color: #f59e0b;
  --quote-color: #6c757d;
  --stats-bg: #e9ecef;
  --stats-text: #495057;
  --dot-bg: #f8f9fa;
  --dot-border: #dee2e6;
  --dot-text: #495057;
  --dot-note-bg: #e3f2fd;
  --dot-note-text: #1565c0;
  --scrollbar-thumb: #adb5bd;
  --scrollbar-thumb-hover: #6c757d;
  --notification-shadow: 0 4px 12px rgba(0,0,0,0.1);
  --panel-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  --modal-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
  --button-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  --input-bg: #ffffff;
  --input-border: #ced4da;
  --input-focus: #2c7be5;
  --table-header-bg: #f8f9fa;
  --table-border: #dee2e6;
  --page-break-color: #ced4da;
  --theme-icon: #6c757d;
}

/* ==================== –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò ==================== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  height: 100%;
  overflow: hidden;
  font-size: 16px;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
  background-color: var(--bg-primary);
  color: var(--text-primary);
  display: flex;
  flex-direction: column;
  transition: background-color 0.3s ease, color 0.3s ease;
  line-height: 1.5;
}

/* ==================== –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ==================== */
.modal-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(10, 12, 20, 0.75);
  backdrop-filter: blur(8px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

.modal-backdrop.active {
  opacity: 1;
  visibility: visible;
}

.modal-content {
  background: var(--modal-bg);
  border: 1px solid var(--modal-border);
  border-radius: 12px;
  width: 90%;
  max-width: 580px;
  padding: 1.8rem;
  position: relative;
  box-shadow: var(--modal-shadow);
  max-height: 85vh;
  overflow-y: auto;
  color: var(--text-primary);
  transform: translateY(10px);
  transition: transform 0.3s ease;
}

.modal-backdrop.active .modal-content {
  transform: translateY(0);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.2rem;
  padding-bottom: 0.8rem;
  border-bottom: 1px solid var(--border-color);
}

.modal-title {
  font-size: 1.4rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.close-modal {
  background: none;
  border: none;
  color: var(--text-secondary);
  font-size: 1.4rem;
  cursor: pointer;
  padding: 0.2rem;
  transition: color 0.2s;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-modal:hover {
  color: var(--accent-color);
  background: rgba(77, 157, 224, 0.1);
}

.modal-body h2 {
  margin: 1rem 0 0.8rem;
  font-size: 1.25rem;
  color: var(--accent-color);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.modal-body p, .modal-body blockquote {
  margin-bottom: 1rem;
  line-height: 1.6;
  font-size: 0.98rem;
}

.modal-body blockquote {
  border-left: 3px solid var(--accent-color);
  padding-left: 1rem;
  color: var(--text-secondary);
  font-style: italic;
  background: rgba(77, 157, 224, 0.08);
  border-radius: 0 4px 4px 0;
  margin: 1.2rem 0;
  padding: 0.8rem 1rem;
}

.modal-link-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: var(--accent-color);
  color: white;
  padding: 0.6rem 1.3rem;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
  margin-top: 0.5rem;
  transition: all 0.2s;
  border: 1px solid var(--accent-color);
  gap: 0.5rem;
  box-shadow: var(--button-shadow);
}

.modal-link-btn:hover {
  background: var(--accent-hover);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.modal-stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  margin-top: 15px;
  text-align: center;
}

.stat-item {
  padding: 15px;
  background: var(--stats-bg);
  border-radius: 10px;
  border: 1px solid var(--border-color);
}

.stat-value {
  font-size: 28px;
  font-weight: bold;
  color: var(--accent-color);
  margin: 5px 0;
  font-family: 'Courier New', monospace;
}

.stat-label {
  font-size: 13px;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* ==================== –®–ê–ü–ö–ê ==================== */
.header {
  background-color: rgba(34, 40, 55, 0.85);
  backdrop-filter: blur(6px);
  border-bottom: 1px solid var(--border-color);
  padding: 0.6rem 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 100;
  flex-shrink: 0;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.header[data-theme="light"] {
  background-color: rgba(255, 255, 255, 0.92);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.header-title {
  font-size: 1.25rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  background: linear-gradient(45deg, var(--accent-color), #6cb4ee);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.header-buttons {
  display: flex;
  gap: 0.75rem;
  align-items: center;
}

.header-btn {
  background: rgba(45, 52, 69, 0.6);
  border: 1px solid var(--border-color);
  color: var(--text-primary);
  padding: 0.45rem 0.95rem;
  border-radius: 8px;
  font-size: 0.9rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.25s ease;
  font-weight: 500;
  box-shadow: var(--button-shadow);
}

.header-btn:hover {
  background: rgba(77, 157, 224, 0.2);
  border-color: var(--accent-color);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.header-btn:active {
  transform: translateY(0);
}

.theme-toggle-btn {
  background: var(--bg-toolbar);
  border: 1px solid var(--border-color);
  width: 42px;
  height: 42px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.25s ease;
  color: var(--theme-icon);
  font-size: 1.1rem;
  box-shadow: var(--button-shadow);
}

.theme-toggle-btn:hover {
  background: var(--accent-color);
  color: white;
  transform: rotate(20deg);
  box-shadow: 0 4px 10px rgba(77, 157, 224, 0.3);
}

/* ==================== –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ ==================== */
.main-container {
  flex: 1;
  display: flex;
  padding: 1.2rem 2.4rem 0.8rem;
  gap: 1.2rem;
  overflow: hidden;
}

.content-area {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.2rem;
  width: 100%;
  height: 100%;
}

.panel {
  background: var(--bg-panel);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: var(--panel-shadow);
  transition: box-shadow 0.3s ease;
}

.panel:hover {
  box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3);
}

.toolbar {
  background: var(--bg-toolbar);
  border-bottom: 1px solid var(--border-color);
  padding: 0.65rem 0.9rem;
  display: flex;
  gap: 0.6rem;
  flex-wrap: wrap;
  flex-shrink: 0;
  justify-content: space-between;
}

.toolbar-left, .toolbar-right {
  display: flex;
  gap: 0.6rem;
  align-items: center;
}

.tool-btn {
  background: rgba(255, 255, 255, 0.07);
  border: 1px solid var(--border-color);
  color: var(--text-primary);
  padding: 0.42rem 0.7rem;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.86rem;
  display: flex;
  align-items: center;
  gap: 0.4rem;
  white-space: nowrap;
  min-width: 80px;
  font-weight: 500;
  box-shadow: var(--button-shadow);
}

.tool-btn:hover {
  background: rgba(77, 157, 224, 0.2);
  border-color: var(--accent-color);
  color: var(--accent-color);
  transform: translateY(-1px);
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
}

.tool-btn:active {
  transform: translateY(0);
}

.tool-btn i {
  font-size: 0.95em;
  min-width: 16px;
  text-align: center;
}

.editor-container {
  position: relative;
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.editor-stats {
  background: var(--stats-bg);
  border-top: 1px solid var(--border-color);
  padding: 0.55rem 1rem;
  font-size: 0.88rem;
  color: var(--stats-text);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-shrink: 0;
  font-family: 'Segoe UI', system-ui, sans-serif;
}

.editor-stats span {
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.editor-stats i {
  color: var(--accent-color);
  font-size: 0.95em;
}

.editor {
  flex: 1;
  padding: 1.1rem;
  font-family: 'Consolas', 'Courier New', monospace;
  font-size: 14px;
  line-height: 1.55;
  resize: none;
  background: var(--bg-primary);
  color: var(--text-primary);
  border: none;
  outline: none;
  caret-color: var(--accent-color);
  overflow: auto;
  transition: background-color 0.3s ease, color 0.3s ease;
}

.editor:focus {
  box-shadow: inset 0 0 0 2px rgba(77, 157, 224, 0.3);
}

/* ==================== –ü–†–ï–î–ü–†–û–°–ú–û–¢–† ==================== */
.preview-header {
  background: var(--bg-toolbar);
  border-bottom: 1px solid var(--border-color);
  padding: 0.65rem 1rem;
  display: flex;
  align-items: center;
  gap: 1.2rem;
  justify-content: space-between;
  height: 48px;
  flex-shrink: 0;
}

.font-size-control {
  display: flex;
  align-items: center;
  gap: 0.65rem;
}

.font-size-control label {
  font-size: 0.9rem;
  color: var(--text-secondary);
  font-weight: 500;
}

.font-size-select {
  background: var(--input-bg);
  border: 1px solid var(--input-border);
  color: var(--text-primary);
  padding: 0.35rem 0.6rem;
  border-radius: 6px;
  font-size: 0.9rem;
  min-width: 70px;
  transition: border-color 0.2s;
}

.font-size-select:focus {
  outline: none;
  border-color: var(--input-focus);
  box-shadow: 0 0 0 2px rgba(77, 157, 224, 0.2);
}

.document-input-group {
  display: flex;
  align-items: center;
  background: var(--input-bg);
  border: 1px solid var(--input-border);
  border-radius: 8px;
  overflow: hidden;
  transition: border-color 0.2s;
}

.document-input-group:focus-within {
  border-color: var(--input-focus);
  box-shadow: 0 0 0 2px rgba(77, 157, 224, 0.2);
}

.document-input-group input {
  background: transparent;
  border: none;
  color: var(--text-primary);
  padding: 0.45rem 0.8rem;
  font-size: 0.95rem;
  outline: none;
  width: 150px;
  min-width: 100px;
  font-weight: 500;
}

.document-extension {
  color: var(--text-secondary);
  padding: 0.45rem 0.8rem;
  font-size: 0.95rem;
  border-left: 1px solid var(--border-color);
  min-width: 42px;
  text-align: center;
  background: rgba(0, 0, 0, 0.03);
}

.download-btn {
  background: linear-gradient(45deg, var(--accent-color), #3a85c9);
  color: white;
  border: 1px solid var(--accent-color);
  padding: 0.45rem 1.1rem;
  border-radius: 8px;
  font-size: 0.95rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.55rem;
  transition: all 0.25s ease;
  font-weight: 600;
  box-shadow: var(--button-shadow);
  min-width: 90px;
  justify-content: center;
}

.download-btn:hover {
  background: linear-gradient(45deg, var(--accent-hover), #2a75b5);
  transform: translateY(-1px);
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.download-btn:active {
  transform: translateY(0);
}

.preview {
  flex: 1;
  padding: 1.5rem;
  overflow: auto;
  display: flex;
  align-items: flex-start;
  justify-content: center;
  background: var(--bg-secondary);
  transition: background-color 0.3s ease;
}

.preview-content {
  background: var(--preview-bg);
  color: var(--preview-text);
  padding: 2.2rem 1.8rem;
  line-height: 1.65;
  font-size: 14px;
  border-radius: 12px;
  box-shadow: 0 5px 25px rgba(0, 0, 0, 0.08);
  width: 78%;
  min-width: 320px;
  max-width: 820px;
  transition: all 0.3s ease;
  position: relative;
}

.preview-content::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--accent-color), #6cb4ee);
  border-radius: 12px 12px 0 0;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
.preview-content h1 {
  font-size: 2.1em;
  margin-bottom: 0.55em;
  border-bottom: 2px solid #eee;
  padding-bottom: 0.35em;
  font-weight: 700;
  line-height: 1.2;
  color: #1a1f2b;
}

.preview-content h2 {
  font-size: 1.65em;
  margin: 1.1em 0 0.6em;
  font-weight: 600;
  color: #2c3e50;
}

.preview-content h3 {
  font-size: 1.35em;
  margin: 1em 0 0.5em;
  font-weight: 600;
  color: #2c3e50;
}

.preview-content p {
  margin: 0.9em 0;
  line-height: 1.65;
}

.preview-content ul,
.preview-content ol {
  padding-left: 1.8rem;
  margin: 1rem 0;
}

.preview-content li {
  margin-bottom: 0.5rem;
  line-height: 1.6;
}

.preview-content blockquote {
  border-left: 4px solid var(--accent-color);
  padding-left: 1.2rem;
  color: var(--quote-color);
  font-style: italic;
  margin: 1.4rem 0;
  background: rgba(77, 157, 224, 0.06);
  padding: 1rem 1.2rem;
  border-radius: 0 6px 6px 0;
  position: relative;
}

.preview-content blockquote::before {
  content: """;
  position: absolute;
  left: -10px;
  top: -5px;
  font-size: 4rem;
  color: rgba(77, 157, 224, 0.15);
  font-family: Georgia, serif;
  line-height: 1;
}

.preview-content code:not(pre code) {
  background: var(--code-bg);
  border: 1px solid var(--code-border);
  border-radius: 4px;
  padding: 0.2rem 0.4rem;
  font-family: 'Consolas', 'Courier New', monospace;
  font-size: 0.93em;
  color: #e06c75;
}

.preview-content pre {
  background: var(--code-bg);
  border: 1px solid var(--code-border);
  border-radius: 8px;
  padding: 1.2rem;
  margin: 1.4rem 0;
  overflow-x: auto;
  font-family: 'Consolas', 'Courier New', monospace;
  font-size: 0.92em;
  line-height: 1.5;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.preview-content pre code {
  background: none;
  border: none;
  padding: 0;
  font-size: inherit;
  color: var(--preview-text);
  line-height: 1.5;
}

/* DOT diagrams */
.dot-diagram-container {
  text-align: center;
  margin: 1.5rem 0;
  background: var(--dot-bg);
  padding: 20px;
  border-radius: 10px;
  border: 1px solid var(--dot-border);
  overflow: hidden;
  page-break-inside: avoid;
  break-inside: avoid;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.dot-diagram-placeholder {
  border: 2px solid var(--accent-color);
  border-radius: 10px;
  padding: 25px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  text-align: left;
}

.dot-diagram-title {
  color: var(--accent-color);
  font-weight: bold;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 17px;
}

.dot-code {
  background: white;
  padding: 18px;
  border-radius: 6px;
  font-family: 'Courier New', monospace;
  font-size: 13.5px;
  white-space: pre-wrap;
  overflow-x: auto;
  border: 1px solid var(--dot-border);
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
  line-height: 1.45;
  margin: 10px 0;
  color: var(--dot-text);
}

.dot-note {
  margin-top: 15px;
  padding: 14px;
  background: var(--dot-note-bg);
  border-radius: 6px;
  font-size: 13.5px;
  color: var(--dot-note-text);
  border-left: 4px solid var(--accent-color);
  line-height: 1.5;
}

.dot-note strong {
  color: var(--accent-color);
}

/* KaTeX —Ñ–æ—Ä–º—É–ª—ã */
.katex {
  font-size: 1.15em;
  font-weight: 500;
}

.katex-display {
  margin: 1.2em 0 !important;
  overflow: auto hidden;
  padding: 0.6em 0;
  text-align: center;
}

.katex-display > .katex {
  display: inline-block;
  text-align: center;
  max-width: 100%;
}

/* –¢–∞–±–ª–∏—Ü—ã */
.preview-content table {
  width: 100%;
  border-collapse: collapse;
  margin: 1.4rem 0;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  border-radius: 8px;
  overflow: hidden;
}

.preview-content th,
.preview-content td {
  border: 1px solid var(--table-border);
  padding: 0.75rem 1rem;
  text-align: left;
  line-height: 1.4;
}

.preview-content th {
  background-color: var(--table-header-bg);
  font-weight: 600;
  color: #2c3e50;
}

.preview-content tr:nth-child(even) {
  background-color: rgba(0, 0, 0, 0.02);
}

/* –†–∞–∑—Ä—ã–≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
.preview-content .page-break {
  page-break-after: always;
  break-after: page;
  height: 1px;
  margin: 2.2rem 0;
  border: none;
  border-top: 1px dashed var(--page-break-color);
  width: 100%;
  position: relative;
  text-align: center;
}

.preview-content .page-break::after {
  content: "‚Ä¢ ‚Ä¢ ‚Ä¢";
  position: absolute;
  top: -10px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--preview-bg);
  padding: 0 10px;
  color: var(--text-secondary);
  font-size: 1.2em;
}

/* ==================== –ü–û–î–í–ê–õ ==================== */
.footer-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.7rem 1.5rem 0.8rem;
  font-size: 0.92rem;
  color: var(--text-secondary);
  border-top: 1px solid var(--border-color);
  background: var(--bg-toolbar);
  flex-shrink: 0;
  margin-top: 0.8rem;
}

.footer-made-by {
  font-weight: 600;
  color: var(--accent-color);
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.footer-slogan {
  font-weight: 500;
  color: var(--text-secondary);
  font-style: italic;
}

.footer-status {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.88rem;
}

.status-dot {
  width: 8px;
  height: 8px;
  background: var(--success-color);
  border-radius: 50%;
  display: inline-block;
}

/* ==================== –°–ö–†–û–õ–õ–ë–ê–†–´ ==================== */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--bg-primary);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: var(--scrollbar-thumb);
  border-radius: 4px;
  border: 2px solid transparent;
  background-clip: content-box;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--scrollbar-thumb-hover);
  border-radius: 4px;
}

/* ==================== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ==================== */
#notification {
  position: fixed;
  bottom: 25px;
  right: 25px;
  background: white;
  color: #1a1f2b;
  padding: 14px 20px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 12px;
  z-index: 2000;
  box-shadow: var(--notification-shadow);
  transform: translateX(400px);
  opacity: 0;
  transition: all 0.35s cubic-bezier(0.16, 1, 0.3, 1);
  max-width: 350px;
  border-left: 4px solid var(--success-color);
}

#notification.show {
  transform: translateX(0);
  opacity: 1;
}

#notification.error {
  border-left-color: var(--error-color);
  background: #fff5f5;
}

#notification.warning {
  border-left-color: var(--warning-color);
  background: #fff9e6;
}

#notification i {
  font-size: 1.3rem;
}

#notification.error i {
  color: var(--error-color);
}

#notification.warning i {
  color: var(--warning-color);
}

#notification.success i {
  color: var(--success-color);
}

#notification button {
  background: none;
  border: none;
  color: #6c757d;
  font-size: 1.2rem;
  cursor: pointer;
  padding: 0 5px;
  display: flex;
  margin-left: 8px;
  border-radius: 4px;
  transition: all 0.2s;
}

#notification button:hover {
  color: var(--text-primary);
  background: rgba(0,0,0,0.05);
}

/* ==================== PDF LOADER ==================== */
.pdf-loader {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(10, 12, 20, 0.82);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s ease;
  backdrop-filter: blur(4px);
}

.pdf-loader.active {
  opacity: 1;
  pointer-events: all;
}

.loader-content {
  background: var(--modal-bg);
  padding: 40px 50px;
  border-radius: 20px;
  box-shadow: 0 15px 40px rgba(0,0,0,0.35);
  text-align: center;
  max-width: 400px;
  width: 90%;
  border: 1px solid var(--modal-border);
}

.loader-spinner {
  position: relative;
  width: 70px;
  height: 70px;
  margin: 0 auto 25px;
}

.loader-spinner-inner {
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  border: 4px solid var(--border-color);
  border-top-color: var(--accent-color);
  animation: spin 0.9s linear infinite;
  box-shadow: 0 0 15px rgba(77, 157, 224, 0.4);
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loader-text {
  font-size: 22px;
  color: var(--text-primary);
  font-weight: 600;
  margin-top: 10px;
  letter-spacing: -0.5px;
}

.loader-subtext {
  font-size: 15px;
  color: var(--text-secondary);
  margin-top: 8px;
  font-weight: 400;
}

/* ==================== DROPDOWN –ú–ï–ù–Æ ==================== */
.dropdown-menu {
  position: absolute;
  background: var(--modal-bg);
  border: 1px solid var(--border-color);
  border-radius: 10px;
  padding: 8px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.2);
  z-index: 100;
  transform: translateY(10px);
  opacity: 0;
  pointer-events: none;
  transition: all 0.25s ease;
  min-width: 220px;
  top: 100%;
  left: 0;
  margin-top: 5px;
}

.dropdown-menu.active {
  opacity: 1;
  pointer-events: all;
  transform: translateY(0);
}

.dropdown-item {
  padding: 10px 14px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 0.92rem;
  font-weight: 500;
}

.dropdown-item:hover {
  background: rgba(77, 157, 224, 0.15);
  color: var(--accent-color);
  transform: translateX(3px);
}

.dropdown-item i {
  width: 20px;
  text-align: center;
  font-size: 0.95em;
}

.dropdown-item pre {
  margin: 5px 0;
  background: none;
  border: none;
  padding: 0;
  color: var(--text-primary);
  font-family: 'Consolas', monospace;
  font-size: 0.9em;
  background: rgba(0,0,0,0.05);
  padding: 3px 6px;
  border-radius: 4px;
}

/* ==================== –†–ï–î–ê–ö–¢–û–† –¢–ê–ë–õ–ò–¶ ==================== */
.table-grid {
  display: grid;
  gap: 3px;
  margin: 15px 0;
  background: var(--border-color);
  padding: 3px;
  border-radius: 8px;
  overflow: hidden;
}

.table-cell {
  background: var(--bg-panel);
  border: none;
  padding: 10px;
  font-family: 'Consolas', monospace;
  font-size: 14px;
  text-align: center;
  color: var(--text-primary);
  border-radius: 4px;
  transition: all 0.2s;
  min-width: 100px;
}

.table-cell:focus {
  outline: 2px solid var(--accent-color);
  background: var(--input-bg);
}

.table-controls {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  margin-top: 15px;
}

.table-controls button {
  padding: 10px;
  background: var(--accent-color);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  box-shadow: var(--button-shadow);
}

.table-controls button:hover {
  background: var(--accent-hover);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.table-controls button:active {
  transform: translateY(0);
}

/* ==================== –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø ==================== */
.image-dropzone {
  border: 2px dashed var(--border-color);
  border-radius: 10px;
  padding: 25px;
  text-align: center;
  margin: 15px 0;
  background: rgba(77, 157, 224, 0.05);
  cursor: pointer;
  transition: all 0.3s;
}

.image-dropzone:hover {
  border-color: var(--accent-color);
  background: rgba(77, 157, 224, 0.1);
}

.image-dropzone.dragover {
  border-color: var(--accent-color);
  background: rgba(77, 157, 224, 0.15);
  transform: scale(1.02);
}

.image-dropzone i {
  font-size: 2.5rem;
  color: var(--accent-color);
  margin-bottom: 10px;
}

.image-dropzone p {
  color: var(--text-secondary);
  margin-top: 8px;
  font-size: 0.95rem;
}

/* ==================== –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ ==================== */
@media (max-width: 1100px) {
  .content-area { 
    grid-template-columns: 1fr; 
  }
  
  .preview-content {
    width: 92%;
    padding: 1.8rem 1.5rem;
  }
  
  .main-container {
    padding: 1rem 1.5rem 0.5rem;
  }
  
  .header {
    padding: 0.5rem 1.5rem;
  }
  
  .header-title {
    font-size: 1.15rem;
  }
  
  .document-input-group {
    max-width: 180px;
  }
  
  .document-input-group input {
    width: 120px;
    font-size: 0.9rem;
  }
  
  .document-extension {
    font-size: 0.9rem;
    min-width: 38px;
  }
  
  .font-size-select {
    min-width: 65px;
    font-size: 0.88rem;
    padding: 0.3rem 0.5rem;
  }
  
  .tool-btn {
    min-width: 70px;
    padding: 0.38rem 0.6rem;
    font-size: 0.85rem;
  }
  
  .tool-btn span {
    display: none;
  }
  
  .tool-btn i {
    margin: 0;
  }
}

@media (max-width: 768px) {
  .toolbar {
    flex-direction: column;
    align-items: stretch;
    gap: 8px;
  }
  
  .toolbar-left, .toolbar-right {
    width: 100%;
    justify-content: space-between;
  }
  
  .preview-header {
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
    height: auto;
  }
  
  .font-size-control, .document-actions {
    width: 100%;
    justify-content: space-between;
  }
  
  .download-btn {
    width: 100%;
    padding: 0.55rem;
    font-size: 1.05rem;
  }
  
  .editor-stats {
    flex-direction: column;
    gap: 8px;
    text-align: center;
  }
  
  .footer-container {
    flex-direction: column;
    gap: 8px;
    text-align: center;
  }
  
  .modal-content {
    width: 95%;
    padding: 1.5rem;
  }
}

@media (max-width: 480px) {
  .header-buttons {
    gap: 0.4rem;
  }
  
  .header-btn {
    padding: 0.4rem 0.6rem;
    font-size: 0.85rem;
  }
  
  .header-btn span {
    display: none;
  }
  
  .theme-toggle-btn {
    width: 38px;
    height: 38px;
  }
  
  .preview-content {
    width: 95%;
    padding: 1.5rem 1.2rem;
    font-size: 13.5px;
  }
  
  .preview-content h1 {
    font-size: 1.9em;
  }
  
  .preview-content h2 {
    font-size: 1.5em;
  }
  
  .editor {
    font-size: 13.5px;
    padding: 0.9rem;
  }
  
  .tool-btn {
    min-width: 60px;
    padding: 0.35rem 0.5rem;
    font-size: 0.8rem;
  }
}
</style>
</head>
<body>
<!-- Modals -->
<div class="modal-backdrop" id="modalInfo">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">
        <i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
      </div>
      <button class="close-modal">&times;</button>
    </div>
    <div class="modal-body">
      <h2><i class="fas fa-file-export"></i> Markdown to PDF Pro</h2>
      <p>–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è Markdown –≤ PDF —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏:</p>
      <ul>
        <li>–ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</li>
        <li>–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–æ—Ä–º—É–ª —á–µ—Ä–µ–∑ KaTeX</li>
        <li>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ DOT-–¥–∏–∞–≥—Ä–∞–º–º (Graphviz)</li>
        <li>–í—Å—Ç–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∏ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞</li>
        <li>–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤</li>
        <li>–°–≤–µ—Ç–ª–∞—è –∏ —Ç—ë–º–Ω–∞—è —Ç–µ–º—ã</li>
        <li>–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</li>
      </ul>
      
      <blockquote>
        <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <code>```dot ... ```</code> –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏–∞–≥—Ä–∞–º–º Graphviz.</p>
        <p>–î–ª—è –≤—Å—Ç–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞ (Ctrl+V).</p>
      </blockquote>
      
      <h2><i class="fas fa-chart-line"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</h2>
      <div class="modal-stats-grid">
        <div class="stat-item">
          <div class="stat-value" id="statDownloads">0</div>
          <div class="stat-label">PDF —Å–∫–∞—á–∞–Ω–æ</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statChars">0</div>
          <div class="stat-label">–°–∏–º–≤–æ–ª–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
        </div>
      </div>
      
      <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--border-color);">
        <button id="clearDraftBtn" class="modal-link-btn" style="background: var(--error-color); border-color: var(--error-color);">
          <i class="fas fa-eraser"></i> –û—á–∏—Å—Ç–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫
        </button>
        <p style="margin-top: 12px; font-size: 0.9rem; color: var(--text-secondary);">
          <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
          –ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–æ –æ—á–∏—Å—Ç–∫–∏. –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–∫–∏–¥–∞—é—Ç –≤–∞—à –∫–æ–º–ø—å—é—Ç–µ—Ä.
        </p>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modalThank">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">
        <i class="fas fa-heart"></i> –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å
      </div>
      <button class="close-modal">&times;</button>
    </div>
    <div class="modal-body">
      <h2><i class="fas fa-code"></i> –°–æ–∑–¥–∞–Ω–æ —Å –ª—é–±–æ–≤—å—é</h2>
      <p>–≠—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –¥–ª—è —É–¥–æ–±–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏. –ê–≤—Ç–æ—Ä –≤–ª–æ–∂–∏–ª –º–Ω–æ–≥–æ —É—Å–∏–ª–∏–π –≤ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.</p>
      
      <div style="background: var(--stats-bg); border-radius: 10px; padding: 15px; margin: 20px 0; border: 1px solid var(--border-color);">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
          <i class="fab fa-github" style="font-size: 1.8rem; color: var(--accent-color);"></i>
          <div>
            <div style="font-weight: 600; font-size: 1.1rem;">Aurum2347</div>
            <div style="color: var(--text-secondary); font-size: 0.95rem;">GitHub –ø—Ä–æ—Ñ–∏–ª—å –∞–≤—Ç–æ—Ä–∞</div>
          </div>
        </div>
        <a href="https://github.com/Aurum2347" target="_blank" class="modal-link-btn" style="width: 100%; justify-content: center;">
          <i class="fab fa-github"></i> –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ GitHub
        </a>
      </div>
      
      <h3 style="margin: 25px 0 15px;"><i class="fas fa-star"></i> –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞</h3>
      <ul>
        <li>–ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π - —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞</li>
        <li>–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π - –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ</li>
        <li>–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π - –±—ã—Å—Ç—Ä–∞—è —Ä–∞–±–æ—Ç–∞ –¥–∞–∂–µ —Å –±–æ–ª—å—à–∏–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏</li>
        <li>–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω - —É–¥–æ–±–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å —Ç—ë–º–Ω–æ–π —Ç–µ–º–æ–π</li>
      </ul>
      
      <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--border-color); text-align: center;">
        <div style="font-size: 3.5rem; margin-bottom: 10px;">‚ù§Ô∏è</div>
        <div style="font-weight: 600; font-size: 1.3rem; margin-bottom: 5px;">–°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ!</div>
        <div style="color: var(--text-secondary);">–í–∞—à–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç –Ω–∞ —Ä–∞–∑–≤–∏—Ç–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</div>
      </div>
    </div>
  </div>
</div>

<!-- Table Modal -->
<div class="modal-backdrop" id="tableModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">
        <i class="fas fa-table"></i> –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É
      </div>
      <button class="close-modal">&times;</button>
    </div>
    <div class="modal-body">
      <p style="margin-bottom: 15px;">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —è—á–µ–π–∫–∏ —Ç–∞–±–ª–∏—Ü—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 2 —Å—Ç—Ä–æ–∫–∏ √ó 3 —Å—Ç–æ–ª–±—Ü–∞)</p>
      
      <div class="table-editor">
        <div class="table-grid" id="tableGrid" style="grid-template-columns: repeat(3, 1fr);"></div>
      </div>
      
      <div class="table-controls">
        <button id="addRowBtn">
          <i class="fas fa-plus"></i> –°—Ç—Ä–æ–∫–∞
        </button>
        <button id="addColBtn">
          <i class="fas fa-plus"></i> –°—Ç–æ–ª–±–µ—Ü
        </button>
        <button id="removeRowBtn" style="background: #e57373;">
          <i class="fas fa-minus"></i> –°—Ç—Ä–æ–∫–∞
        </button>
        <button id="removeColBtn" style="background: #e57373;">
          <i class="fas fa-minus"></i> –°—Ç–æ–ª–±–µ—Ü
        </button>
      </div>
      
      <button id="insertTableConfirm" style="width:100%; margin-top:20px; padding: 12px; background: linear-gradient(45deg, var(--accent-color), #3a85c9); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 1.05rem; box-shadow: var(--button-shadow);">
        <i class="fas fa-table"></i> –í—Å—Ç–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –≤ –¥–æ–∫—É–º–µ–Ω—Ç
      </button>
      
      <div style="margin-top: 15px; padding: 12px; background: var(--stats-bg); border-radius: 8px; border: 1px solid var(--border-color); font-size: 0.9rem;">
        <i class="fas fa-lightbulb" style="color: var(--accent-color); margin-right: 5px;"></i>
        –°–æ–≤–µ—Ç: –ü–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –≤—ã –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –µ—ë –ø—Ä—è–º–æ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ Markdown.
      </div>
    </div>
  </div>
</div>

<!-- Header -->
<div class="header">
  <div class="header-title">
    <i class="fas fa-file-pdf"></i> Markdown2PDF Pro
  </div>
  <div class="header-buttons">
    <button class="header-btn" data-modal="modalInfo">
      <i class="fas fa-info-circle"></i> <span>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</span>
    </button>
    <button class="header-btn" data-modal="modalThank">
      <i class="fas fa-heart"></i> <span>–ê–≤—Ç–æ—Ä</span>
    </button>
    <div class="theme-toggle-btn" id="themeToggle">
      <i class="fas fa-moon"></i>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="main-container">
  <div class="content-area">
    <div class="panel">
      <div class="toolbar">
        <div class="toolbar-left">
          <div style="position: relative;">
            <button class="tool-btn" title="–ó–∞–≥–æ–ª–æ–≤–æ–∫" id="insertHeading">
              <i class="fas fa-heading"></i> <span>–ó–∞–≥–æ–ª–æ–≤–æ–∫</span>
            </button>
            <div class="dropdown-menu" id="headingMenu">
              <div class="dropdown-item" onclick="insertTextAtCursor('–ó–∞–≥–æ–ª–æ–≤–æ–∫ 1', '# ', '')">
                <i class="fas fa-heading"></i> <pre># –ó–∞–≥–æ–ª–æ–≤–æ–∫ 1</pre>
              </div>
              <div class="dropdown-item" onclick="insertTextAtCursor('–ó–∞–≥–æ–ª–æ–≤–æ–∫ 2', '## ', '')">
                <i class="fas fa-heading"></i> <pre>## –ó–∞–≥–æ–ª–æ–≤–æ–∫ 2</pre>
              </div>
              <div class="dropdown-item" onclick="insertTextAtCursor('–ó–∞–≥–æ–ª–æ–≤–æ–∫ 3', '### ', '')">
                <i class="fas fa-heading"></i> <pre>### –ó–∞–≥–æ–ª–æ–≤–æ–∫ 3</pre>
              </div>
              <div class="dropdown-item" onclick="insertTextAtCursor('–ó–∞–≥–æ–ª–æ–≤–æ–∫ 4', '#### ', '')">
                <i class="fas fa-heading"></i> <pre>#### –ó–∞–≥–æ–ª–æ–≤–æ–∫ 4</pre>
              </div>
            </div>
          </div>
          <button class="tool-btn" title="–ñ–∏—Ä–Ω—ã–π" data-format="bold">
            <i class="fas fa-bold"></i> <span>–ñ–∏—Ä–Ω—ã–π</span>
          </button>
          <button class="tool-btn" title="–ö—É—Ä—Å–∏–≤" data-format="italic">
            <i class="fas fa-italic"></i> <span>–ö—É—Ä—Å–∏–≤</span>
          </button>
          <button class="tool-btn" title="–°—Å—ã–ª–∫–∞" data-format="link">
            <i class="fas fa-link"></i> <span>–°—Å—ã–ª–∫–∞</span>
          </button>
          <button class="tool-btn" title="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" data-format="image">
            <i class="fas fa-image"></i> <span>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</span>
          </button>
          <button class="tool-btn" title="–¢–∞–±–ª–∏—Ü–∞" id="insertTableBtn">
            <i class="fas fa-table"></i> <span>–¢–∞–±–ª–∏—Ü–∞</span>
          </button>
        </div>
        <div class="toolbar-right">
          <button class="tool-btn" title="–°–ø–∏—Å–æ–∫" data-format="list">
            <i class="fas fa-list"></i> <span>–°–ø–∏—Å–æ–∫</span>
          </button>
          <button class="tool-btn" title="–ö–æ–¥" data-format="code">
            <i class="fas fa-code"></i> <span>–ö–æ–¥</span>
          </button>
          <button class="tool-btn" title="–¶–∏—Ç–∞—Ç–∞" data-format="quote">
            <i class="fas fa-quote-right"></i> <span>–¶–∏—Ç–∞—Ç–∞</span>
          </button>
          <button class="tool-btn" title="–†–∞–∑—Ä—ã–≤" data-format="pageBreak">
            <i class="fas fa-scissors"></i> <span>–†–∞–∑—Ä—ã–≤</span>
          </button>
        </div>
      </div>
      <div class="editor-container">
        <textarea class="editor" id="markdownEditor" placeholder="–ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å –≤–∞—à –¥–æ–∫—É–º–µ–Ω—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown..."># –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Markdown2PDF Pro!

–≠—Ç–æ —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ Markdown –≤ PDF. –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä.

## üî• –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ** - –≤–∞—à —Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
- **–í—Å—Ç–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** - –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ –∏–∑ –±—É—Ñ–µ—Ä–∞ (Ctrl+V)
- **–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞** - –ø–µ—Ä–µ–∫–ª—é—á–∞–π—Ç–µ—Å—å –º–µ–∂–¥—É —Ç–µ–º–Ω–æ–π –∏ —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º–æ–π
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤ –∏ —Å–ª–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- **–£–ª—É—á—à–µ–Ω–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç** - –∏–¥–µ–∞–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ PDF
- **DOT-–¥–∏–∞–≥—Ä–∞–º–º—ã** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Graphviz –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ö–µ–º

## üìê –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—É–ª—ã

–ò–Ω–ª–∞–π–Ω —Ñ–æ—Ä–º—É–ª–∞: $E = mc^2$

–ë–ª–æ—á–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞:
$$
\int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}
$$

## üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

–ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+V –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞.

## üìä –¢–∞–±–ª–∏—Ü—ã

| –°–∏–Ω—Ç–∞–∫—Å–∏—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
| --------- | -------- |
| –ó–∞–≥–æ–ª–æ–≤–æ–∫ | –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã |
| –Ø—á–µ–π–∫–∞ | –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —è—á–µ–π–∫–∏ |
| –°—Ç—Ä–æ–∫–∞ | –î–∞–Ω–Ω—ã–µ –≤ —Å—Ç—Ä–æ–∫–µ |

## üí° –¶–∏—Ç–∞—Ç–∞

> "–õ—É—á—à–∏–π —Å–ø–æ—Å–æ–± –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å –±—É–¥—É—â–µ–µ ‚Äî –∏–∑–æ–±—Ä–µ—Å—Ç–∏ –µ–≥–æ."
> ‚Äî –ê–ª–∞–Ω –ö–µ–π

## üîó –°—Å—ã–ª–∫–∏

[–ü–æ—Å–µ—Ç–∏—Ç–µ GitHub –∞–≤—Ç–æ—Ä–∞](https://github.com/Aurum2347)

## üìÅ –ë–ª–æ–∫-—Å—Ö–µ–º–∞ DOT

```dot
digraph G {
  rankdir=LR;
  node [shape=rectangle, style=filled, fillcolor="#e3f2fd", color="#2c7be5"];
  
  Start [label="–ù–∞—á–∞–ª–æ", fillcolor="#bbdefb"];
  Process1 [label="–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö"];
  Decision [shape=diamond, label="–£—Å–ª–æ–≤–∏–µ?", fillcolor="#e8f5e9"];
  Process2 [label="–î–µ–π—Å—Ç–≤–∏–µ 1", fillcolor="#e8f5e9"];
  Process3 [label="–î–µ–π—Å—Ç–≤–∏–µ 2", fillcolor="#fff3e0"];
  End [label="–ö–æ–Ω–µ—Ü", fillcolor="#ffcdd2"];
  
  Start -> Process1;
  Process1 -> Decision;
  Decision -> Process2 [label="–î–∞"];
  Decision -> Process3 [label="–ù–µ—Ç"];
  Process2 -> End;
  Process3 -> End;
}
```

## üìÑ –†–∞–∑—Ä—ã–≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

–¢–µ–∫—Å—Ç –¥–æ —Ä–∞–∑—Ä—ã–≤–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã...

---

–¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ —Ä–∞–∑—Ä—ã–≤–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –º–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤!

## ‚ú® –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–≠—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —É–¥–æ–±—Å—Ç–≤–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏. –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∏ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã. –ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è!</textarea>
        <div class="editor-stats">
          <span><i class="fas fa-text-height"></i> –°–∏–º–≤–æ–ª–æ–≤: <strong id="charCount">0</strong></span>
          <span><i class="fas fa-font"></i> –°–ª–æ–≤: <strong id="wordCount">0</strong></span>
          <span><i class="fas fa-save"></i> <span id="saveStatus">–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ</span></span>
        </div>
      </div>
    </div>
    
    <div class="panel">
      <div class="preview-header">
        <div class="font-size-control">
          <label for="fontSizeSelect"><i class="fas fa-text-size"></i> –†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞:</label>
          <select class="font-size-select" id="fontSizeSelect">
            <option value="12">12px</option>
            <option value="14" selected>14px</option>
            <option value="16">16px</option>
            <option value="18">18px</option>
          </select>
        </div>
        <div class="document-actions" style="display:flex;gap:1rem;align-items:center;">
          <div class="document-input-group">
            <input type="text" id="documentName" value="document" maxlength="50">
            <div class="document-extension">.pdf</div>
          </div>
          <button class="download-btn" id="downloadPdf">
            <i class="fas fa-download"></i> <span>–°–∫–∞—á–∞—Ç—å PDF</span>
          </button>
        </div>
      </div>
      <div class="preview">
        <div class="preview-content" id="previewContent"></div>
      </div>
      <div class="footer-container">
        <div>
          <span class="footer-status">
            <span class="status-dot"></span> –ì–æ—Ç–æ–≤–æ –∫ —ç–∫—Å–ø–æ—Ä—Ç—É
          </span>
        </div>
        <div>
          <span class="footer-made-by">
            <i class="fas fa-code"></i> By Aurum2347
          </span>
        </div>
        <div>
          <span class="footer-slogan">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Notification -->
<div id="notification">
  <i class="fas fa-check-circle success"></i>
  <span id="notificationText">–î–æ–∫—É–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!</span>
  <button onclick="closeNotification()">&times;</button>
</div>

<!-- PDF Loader -->
<div class="pdf-loader">
  <div class="loader-content">
    <div class="loader-spinner">
      <div class="loader-spinner-inner"></div>
    </div>
    <div class="loader-text">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF</div>
    <div class="loader-subtext">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...</div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/lib/marked.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
<script>
// ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
let graphvizInstance = null;
let draftTimeout = null;
let imageCache = new Map(); // –ö—ç—à –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–¥–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
let isLocalFile = window.location.protocol === 'file:';
let themeToggleBtn = null;
let editor = null;
let preview = null;
let downloadBtn = null;
let documentNameInput = null;
let docNameLabel = null;
let fontSizeSelect = null;
let notification = null;
let pdfLoader = null;
let insertHeadingBtn = null;
let headingMenu = null;
let insertTableBtn = null;
let charCountEl = null;
let wordCountEl = null;
let saveStatusEl = null;
let downloadCount = 0;
let totalChars = 0;

// ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ====================
document.addEventListener('DOMContentLoaded', async () => {
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ DOM
  editor = document.getElementById('markdownEditor');
  preview = document.getElementById('previewContent');
  downloadBtn = document.getElementById('downloadPdf');
  documentNameInput = document.getElementById('documentName');
  fontSizeSelect = document.getElementById('fontSizeSelect');
  notification = document.getElementById('notification');
  pdfLoader = document.querySelector('.pdf-loader');
  insertHeadingBtn = document.getElementById('insertHeading');
  headingMenu = document.getElementById('headingMenu');
  insertTableBtn = document.getElementById('insertTableBtn');
  charCountEl = document.getElementById('charCount');
  wordCountEl = document.getElementById('wordCount');
  saveStatusEl = document.getElementById('saveStatus');
  themeToggleBtn = document.getElementById('themeToggle');
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  downloadCount = parseInt(localStorage.getItem('downloadCount') || '0');
  totalChars = parseInt(localStorage.getItem('totalChars') || '0');
  document.getElementById('statDownloads').textContent = downloadCount;
  document.getElementById('statChars').textContent = totalChars;
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º—ã
  loadTheme();
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–∞
  loadDraft();
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  updateStats();
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
  updatePreview();
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ KaTeX
  await loadKaTeX();
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ Graphviz (–µ—Å–ª–∏ –Ω–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª)
  if (!isLocalFile) {
    loadGraphviz();
  }
  
  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
  setupEventListeners();
  
  // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
  setTimeout(() => {
    showNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Markdown2PDF Pro! –ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.', 'success', 5000);
  }, 1000);
});

// ==================== –ó–ê–ì–†–£–ó–ö–ê –¢–ï–ú–´ ====================
function loadTheme() {
  const savedTheme = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', savedTheme);
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è —Ç–µ–º—ã
  const icon = themeToggleBtn.querySelector('i');
  if (savedTheme === 'dark') {
    icon.className = 'fas fa-moon';
    icon.title = '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É';
  } else {
    icon.className = 'fas fa-sun';
    icon.title = '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Ç–µ–º–Ω—É—é —Ç–µ–º—É';
  }
}

// ==================== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –¢–ï–ú–´ ====================
themeToggleBtn?.addEventListener('click', () => {
  const currentTheme = document.documentElement.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  
  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏
  const icon = themeToggleBtn.querySelector('i');
  if (newTheme === 'dark') {
    icon.className = 'fas fa-moon';
    icon.title = '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É';
    showNotification('–¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞', 'success', 2000);
  } else {
    icon.className = 'fas fa-sun';
    icon.title = '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Ç–µ–º–Ω—É—é —Ç–µ–º—É';
    showNotification('–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞', 'success', 2000);
  }
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å—Ç–∏–ª–µ–π
  updatePreview();
});

// ==================== –ó–ê–ì–†–£–ó–ö–ê KATEX ====================
async function loadKaTeX() {
  return new Promise((resolve, reject) => {
    if (window.katex && window.renderMathInElement) {
      resolve();
      return;
    }
    
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js';
    script.onload = () => {
      const renderScript = document.createElement('script');
      renderScript.src = 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js';
      renderScript.onload = () => resolve();
      renderScript.onerror = reject;
      document.head.appendChild(renderScript);
    };
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

// ==================== –ó–ê–ì–†–£–ó–ö–ê GRAPHVIZ ====================
async function loadGraphviz() {
  if (isLocalFile) return null;
  
  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É Graphviz
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/@hpcc-js/wasm@2.15.0/dist/graphviz.umd.min.js';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä
    graphvizInstance = await window.Graphviz.load();
    console.log('Graphviz —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω');
    
    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∏–∞–≥—Ä–∞–º–º
    updatePreview();
    
    return graphvizInstance;
  } catch (error) {
    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Graphviz:', error);
    return null;
  }
}

// ==================== –ù–ê–°–¢–†–û–ô–ö–ê –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í –°–û–ë–´–¢–ò–ô ====================
function setupEventListeners() {
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ
  editor.addEventListener('input', () => {
    updatePreview();
    updateStats();
    
    // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å debounce
    clearTimeout(draftTimeout);
    draftTimeout = setTimeout(() => {
      localStorage.setItem('markdownDraft', editor.value);
      saveStatusEl.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
      setTimeout(() => {
        saveStatusEl.textContent = '–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ';
      }, 2000);
    }, 2000);
  });
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  document.querySelectorAll('.tool-btn[data-format]').forEach(btn => {
    btn.addEventListener('click', () => {
      const format = btn.dataset.format;
      applyFormat(format);
    });
  });
  
  // –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
  insertHeadingBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    const rect = insertHeadingBtn.getBoundingClientRect();
    headingMenu.style.left = `${rect.left}px`;
    headingMenu.style.top = `${rect.bottom + 5}px`;
    headingMenu.classList.toggle('active');
  });
  
  // –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
  document.addEventListener('click', (e) => {
    if (!insertHeadingBtn.contains(e.target) && !headingMenu.contains(e.target)) {
      headingMenu.classList.remove('active');
    }
  });
  
  // –¢–∞–±–ª–∏—á–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä
  insertTableBtn.addEventListener('click', () => {
    initTableEditor();
    document.getElementById('tableModal').classList.add('active');
    document.body.style.overflow = 'hidden';
  });
  
  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
  document.querySelectorAll('.close-modal, .modal-backdrop').forEach(el => {
    el.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-backdrop') || e.target.classList.contains('close-modal')) {
        document.querySelectorAll('.modal-backdrop').forEach(m => m.classList.remove('active'));
        document.body.style.overflow = '';
      }
    });
  });
  
  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü–µ–π
  document.getElementById('addRowBtn').addEventListener('click', addTableRow);
  document.getElementById('addColBtn').addEventListener('click', addTableColumn);
  document.getElementById('removeRowBtn').addEventListener('click', removeTableRow);
  document.getElementById('removeColBtn').addEventListener('click', removeTableColumn);
  document.getElementById('insertTableConfirm').addEventListener('click', insertTable);
  
  // –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF
  downloadBtn.addEventListener('click', downloadPDF);
  
  // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
  documentNameInput.addEventListener('input', () => {
    // –û—á–∏—Å—Ç–∫–∞ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
    documentNameInput.value = documentNameInput.value.replace(/[<>:"/\\|?*]/g, '');
  });
  
  // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞
  fontSizeSelect.addEventListener('change', () => {
    preview.style.fontSize = fontSizeSelect.value + 'px';
  });
  
  // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –∏–∑ —à–∞–ø–∫–∏
  document.querySelectorAll('[data-modal]').forEach(btn => {
    btn.addEventListener('click', () => {
      const modalId = btn.dataset.modal;
      document.getElementById(modalId).classList.add('active');
      document.body.style.overflow = 'hidden';
    });
  });
  
  // –û—á–∏—Å—Ç–∫–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–∞
  document.getElementById('clearDraftBtn').addEventListener('click', () => {
    localStorage.removeItem('markdownDraft');
    editor.value = '# –ù–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç\n\n–ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å –∑–¥–µ—Å—å...';
    updatePreview();
    updateStats();
    showNotification('–ß–µ—Ä–Ω–æ–≤–∏–∫ —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω', 'success');
    document.getElementById('modalInfo').classList.remove('active');
  });
  
  // –í—Å—Ç–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
  editor.addEventListener('paste', handleImagePaste);
  
  // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
  editor.addEventListener('dragover', (e) => {
    e.preventDefault();
    editor.classList.add('dragover');
  });
  
  editor.addEventListener('dragleave', () => {
    editor.classList.remove('dragover');
  });
  
  editor.addEventListener('drop', handleImageDrop);
  
  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.querySelectorAll('.modal-backdrop.active').forEach(modal => {
        modal.classList.remove('active');
      });
      document.body.style.overflow = '';
      headingMenu.classList.remove('active');
    }
  });
}

// ==================== –§–£–ù–ö–¶–ò–ò –†–ï–î–ê–ö–¢–û–†–ê ====================
function applyFormat(format) {
  const startPos = editor.selectionStart;
  const endPos = editor.selectionEnd;
  const selectedText = editor.value.substring(startPos, endPos);
  let newText = '';
  
  switch(format) {
    case 'bold':
      newText = `**${selectedText || '–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç'}**`;
      break;
    case 'italic':
      newText = `*${selectedText || '–∫—É—Ä—Å–∏–≤–Ω—ã–π —Ç–µ–∫—Å—Ç'}*`;
      break;
    case 'link':
      newText = `[${selectedText || '—Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏'}](https://example.com)`;
      break;
    case 'image':
      newText = `![${selectedText || '–æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'}](https://example.com/image.jpg)`;
      break;
    case 'list':
      newText = selectedText 
        ? selectedText.split('\n').map(line => `- ${line}`).join('\n')
        : `- –≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ 1\n- –≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ 2\n- –≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ 3`;
      break;
    case 'code':
      newText = selectedText 
        ? `\`\`\`\n${selectedText}\n\`\`\``
        : `\`\`\`\n// –í–∞—à –∫–æ–¥ –∑–¥–µ—Å—å\nconsole.log("–ü—Ä–∏–≤–µ—Ç, –º–∏—Ä!");\n\`\`\``;
      break;
    case 'quote':
      newText = selectedText 
        ? selectedText.split('\n').map(line => `> ${line}`).join('\n')
        : `> –≠—Ç–æ —Ü–∏—Ç–∞—Ç–∞\n> –í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞ —Ü–∏—Ç–∞—Ç—ã`;
      break;
    case 'pageBreak':
      newText = '\n---\n';
      break;
  }
  
  editor.value = editor.value.substring(0, startPos) + newText + editor.value.substring(endPos);
  editor.selectionStart = startPos;
  editor.selectionEnd = startPos + newText.length;
  editor.focus();
  updatePreview();
}

function insertTextAtCursor(text, wrapBefore = '', wrapAfter = '') {
  const startPos = editor.selectionStart;
  const endPos = editor.selectionEnd;
  const selectedText = editor.value.substring(startPos, endPos);
  
  editor.value = editor.value.substring(0, startPos) +
    wrapBefore + (selectedText || text) + wrapAfter +
    editor.value.substring(endPos);
  
  if (selectedText) {
    editor.selectionStart = startPos;
    editor.selectionEnd = endPos + wrapBefore.length + wrapAfter.length;
  } else {
    editor.selectionStart = editor.selectionEnd = startPos + wrapBefore.length + text.length;
  }
  
  editor.focus();
  updatePreview();
}

// ==================== –í–°–¢–ê–í–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô ====================
async function handleImagePaste(e) {
  const clipboardData = e.clipboardData;
  const items = clipboardData.items;
  
  for (let i = 0; i < items.length; i++) {
    if (items[i].type.indexOf('image') !== -1) {
      e.preventDefault();
      const file = items[i].getAsFile();
      
      if (file.size > 1024 * 1024) { // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 1 –ú–ë
        showNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (–º–∞–∫—Å. 1 –ú–ë)', 'error');
        return;
      }
      
      await insertImageFile(file);
      return;
    }
  }
}

async function handleImageDrop(e) {
  e.preventDefault();
  editor.classList.remove('dragover');
  
  if (e.dataTransfer.files.length) {
    const file = e.dataTransfer.files[0];
    
    if (!file.type.match('image.*')) {
      showNotification('–ú–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'warning');
      return;
    }
    
    if (file.size > 1024 * 1024) { // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 1 –ú–ë
      showNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (–º–∞–∫—Å. 1 –ú–ë)', 'error');
      return;
    }
    
    await insertImageFile(file);
  }
}

async function insertImageFile(file) {
  const reader = new FileReader();
  
  return new Promise((resolve) => {
    reader.onload = async (event) => {
      const base64 = event.target.result;
      const fileName = file.name.replace(/\.[^/.]+$/, "");
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à (–¥–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
      const cacheKey = `img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      imageCache.set(cacheKey, base64);
      
      // –í—Å—Ç–∞–≤–ª—è–µ–º –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
      const startPos = editor.selectionStart;
      const endPos = editor.selectionEnd;
      const imgMarkdown = `![${fileName}](${cacheKey})`;
      
      editor.value = editor.value.substring(0, startPos) + imgMarkdown + editor.value.substring(endPos);
      editor.selectionStart = editor.selectionEnd = startPos + imgMarkdown.length;
      editor.focus();
      
      updatePreview();
      showNotification(`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ "${fileName}" –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –¥–æ–∫—É–º–µ–Ω—Ç`, 'success');
      resolve();
    };
    
    reader.readAsDataURL(file);
  });
}

// ==================== –¢–ê–ë–õ–ò–ß–ù–´–ô –†–ï–î–ê–ö–¢–û–† ====================
let tableData = [
  ['', '', ''],
  ['', '', '']
];

function initTableEditor() {
  tableData = [
    ['', '', ''],
    ['', '', '']
  ];
  renderTableEditor();
}

function renderTableEditor() {
  const tableGrid = document.getElementById('tableGrid');
  tableGrid.innerHTML = '';
  tableGrid.style.gridTemplateColumns = `repeat(${tableData[0].length}, 1fr)`;
  
  tableData.forEach((row, i) => {
    row.forEach((cell, j) => {
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'table-cell';
      input.value = cell;
      input.dataset.row = i;
      input.dataset.col = j;
      input.placeholder = `–Ø—á–µ–π–∫–∞ ${i+1},${j+1}`;
      
      input.addEventListener('input', (e) => {
        tableData[i][j] = e.target.value;
      });
      
      tableGrid.appendChild(input);
    });
  });
}

function addTableRow() {
  const newRow = Array(tableData[0].length).fill('');
  tableData.push(newRow);
  renderTableEditor();
}

function addTableColumn() {
  tableData.forEach(row => row.push(''));
  renderTableEditor();
}

function removeTableRow() {
  if (tableData.length > 1) {
    tableData.pop();
    renderTableEditor();
  } else {
    showNotification('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É', 'warning');
  }
}

function removeTableColumn() {
  if (tableData[0].length > 1) {
    tableData.forEach(row => row.pop());
    renderTableEditor();
  } else {
    showNotification('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–æ–ª–±–µ—Ü', 'warning');
  }
}

function insertTable() {
  let md = '';
  
  // –ó–∞–≥–æ–ª–æ–≤–∫–∏
  md += '| ' + tableData[0].map(c => c || '–ó–∞–≥–æ–ª–æ–≤–æ–∫').join(' | ') + ' |\n';
  // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
  md += '| ' + tableData[0].map(() => '---').join(' | ') + ' |\n';
  // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
  for (let i = 1; i < tableData.length; i++) {
    md += '| ' + tableData[i].map(c => c || ' ').join(' | ') + ' |\n';
  }
  
  // –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
  const startPos = editor.selectionStart;
  editor.value = editor.value.substring(0, startPos) + '\n' + md + '\n' + editor.value.substring(startPos);
  editor.focus();
  
  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
  document.getElementById('tableModal').classList.remove('active');
  document.body.style.overflow = '';
  
  updatePreview();
  showNotification('–¢–∞–±–ª–∏—Ü–∞ —É—Å–ø–µ—à–Ω–æ –≤—Å—Ç–∞–≤–ª–µ–Ω–∞', 'success');
}

// ==================== –ê–í–¢–û–°–û–•–†–ê–ù–ï–ù–ò–ï –ò –°–¢–ê–¢–ò–°–¢–ò–ö–ê ====================
function loadDraft() {
  const savedDraft = localStorage.getItem('markdownDraft');
  if (savedDraft && savedDraft !== '# –ù–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç\n\n–ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å –∑–¥–µ—Å—å...') {
    editor.value = savedDraft;
    showNotification('–ß–µ—Ä–Ω–æ–≤–∏–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'success', 3000);
  }
}

function updateStats() {
  const text = editor.value;
  charCountEl.textContent = text.length;
  
  // –ü–æ–¥—Å—á–µ—Ç —Å–ª–æ–≤ (—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–æ–±–µ–ª–∞–º, –∑–Ω–∞–∫–∞–º –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –∏ –ø–µ—Ä–µ–Ω–æ—Å–∞–º —Å—Ç—Ä–æ–∫)
  const words = text.trim().split(/\s+/).filter(word => word.length > 0);
  wordCountEl.textContent = words.length;
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  totalChars += text.length - totalChars;
  localStorage.setItem('totalChars', totalChars.toString());
  document.getElementById('statChars').textContent = totalChars;
}

// ==================== –ü–†–ï–î–ü–†–û–°–ú–û–¢–† ====================
function updatePreview() {
  let text = editor.value;
  
  // –ó–∞–º–µ–Ω—è–µ–º –∫–ª—é—á–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ –∫—ç—à–∞ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ base64
  text = text.replace(/!\[([^\]]*)\]\((img_[^)]+)\)/g, (match, alt, key) => {
    const base64 = imageCache.get(key);
    return base64 ? `![${alt}](${base64})` : match;
  });
  
  try {
    // –ü–∞—Ä—Å–∏–º Markdown
    const html = marked.parse(text, {
      breaks: true,
      gfm: true,
      mangle: false,
      headerIds: false
    });
    
    // –û—á–∏—â–∞–µ–º HTML
    const clean = DOMPurify.sanitize(html, {
      USE_PROFILES: { html: true },
      ADD_TAGS: ['svg', 'g', 'path', 'circle', 'rect', 'polygon', 'polyline', 'line', 'ellipse', 'text', 'image'],
      ADD_ATTR: ['d', 'x', 'y', 'width', 'height', 'r', 'cx', 'cy', 'rx', 'ry', 'points', 'x1', 'y1', 'x2', 'y2', 'transform', 'fill', 'stroke', 'stroke-width', 'viewBox', 'xmlns', 'style', 'class', 'href', 'preserveAspectRatio']
    });
    
    preview.innerHTML = clean;
    
    // –†–µ–Ω–¥–µ—Ä –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏ KaTeX
    if (window.renderMathInElement) {
      renderMathInElement(preview, {
        delimiters: [
          {left: '$$', right: '$$', display: true},
          {left: '\\[', right: '\\]', display: true},
          {left: '$', right: '$', display: false},
          {left: '\\(', right: '\\)', display: false}
        ],
        throwOnError: false,
        errorColor: '#cc0000',
        strict: false
      });
    }
    
    // –†–µ–Ω–¥–µ—Ä DOT –¥–∏–∞–≥—Ä–∞–º–º
    renderDotDiagrams();
    
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ Markdown:', e);
    preview.innerHTML = `<p style="color: var(--error-color); padding: 20px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid var(--error-color);">
      <strong>–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ Markdown:</strong> ${e.message}
    </p>`;
  }
  
  // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞
  preview.style.fontSize = fontSizeSelect.value + 'px';
}

// ==================== –†–ï–ù–î–ï–† DOT –î–ò–ê–ì–†–ê–ú–ú ====================
async function renderDotDiagrams() {
  const containers = preview.querySelectorAll('.dot-diagram-container');
  
  for (const container of containers) {
    if (container.hasAttribute('data-rendered')) continue;
    
    const dotCode = container.textContent.trim();
    if (!dotCode) continue;
    
    try {
      // –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω Graphviz –∏ –Ω–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª - —Ä–µ–Ω–¥–µ—Ä–∏–º –≤ SVG
      if (graphvizInstance && !isLocalFile) {
        const svg = await graphvizInstance.layout(dotCode, 'svg', 'dot');
        container.innerHTML = svg;
        container.setAttribute('data-rendered', 'true');
        container.style.background = 'white';
        container.style.padding = '0';
        container.style.border = 'none';
        container.querySelector('svg').style.maxWidth = '100%';
        container.querySelector('svg').style.height = 'auto';
      } else {
        // Fallback: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–¥ –¥–∏–∞–≥—Ä–∞–º–º—ã —Å –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º
        container.innerHTML = `
          <div class="dot-diagram-placeholder">
            <div class="dot-diagram-title">
              <i class="fas fa-diagram-project"></i> Graphviz –¥–∏–∞–≥—Ä–∞–º–º–∞
            </div>
            <div class="dot-code">${escapeHtml(dotCode)}</div>
            <div class="dot-note">
              <strong>üí° –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –î–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∏–∞–≥—Ä–∞–º–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, GitHub Pages). 
              –ü—Ä–∏ –ª–æ–∫–∞–ª—å–Ω–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–∞–π–ª–æ–≤ –¥–∏–∞–≥—Ä–∞–º–º—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –≤–∏–¥–µ –∫–æ–¥–∞.
            </div>
          </div>
        `;
        container.setAttribute('data-rendered', 'true');
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ DOT –¥–∏–∞–≥—Ä–∞–º–º—ã:', error);
      container.innerHTML = `
        <div style="padding: 20px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid var(--error-color);">
          <strong>–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –¥–∏–∞–≥—Ä–∞–º–º—ã:</strong> ${error.message}
          <pre style="margin-top: 10px; background: rgba(0,0,0,0.05); padding: 10px; border-radius: 4px;">${escapeHtml(dotCode)}</pre>
        </div>
      `;
      container.setAttribute('data-rendered', 'true');
    }
  }
}

function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// ==================== –≠–ö–°–ü–û–†–¢ –í PDF ====================
async function downloadPDF() {
  const filename = (documentNameInput.value.trim() || 'document').replace(/[<>:"/\\|?*]/g, '');
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π –¥–æ–∫—É–º–µ–Ω—Ç
  if (!editor.value.trim()) {
    showNotification('–ù–µ–ª—å–∑—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—É—Å—Ç–æ–π –¥–æ–∫—É–º–µ–Ω—Ç', 'error');
    return;
  }
  
  pdfLoader.classList.add('active');
  
  try {
    // –°–æ–∑–¥–∞–µ–º –∫–ª–æ–Ω –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
    const clone = preview.cloneNode(true);
    clone.id = '';
    clone.style.width = '595pt'; // –®–∏—Ä–∏–Ω–∞ A4 –≤ –ø—É–Ω–∫—Ç–∞—Ö
    clone.style.padding = '40pt 30pt';
    clone.style.margin = '0';
    clone.style.boxSizing = 'border-box';
    clone.style.fontSize = `${fontSizeSelect.value}px`;
    clone.style.color = '#1a1f2b';
    clone.style.background = 'white';
    clone.style.boxShadow = 'none';
    
    // –£–±–∏—Ä–∞–µ–º –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø–µ—á–∞—Ç–∏
    const decorativeElements = clone.querySelectorAll('.dot-diagram-title, .dot-note, .status-dot, .footer-slogan');
    decorativeElements.forEach(el => el.remove());
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –∫—ç—à–µ –¥–ª—è PDF
    const images = clone.querySelectorAll('img');
    for (const img of images) {
      if (img.src.startsWith('img_')) {
        const base64 = imageCache.get(img.src);
        if (base64) img.src = base64;
      }
    }
    
    // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
    const tempContainer = document.createElement('div');
    tempContainer.style.position = 'absolute';
    tempContainer.style.left = '-9999px';
    tempContainer.style.top = '0';
    tempContainer.appendChild(clone);
    document.body.appendChild(tempContainer);
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
    const options = {
      margin: [25, 20, 25, 20],
      filename: `${filename}.pdf`,
      html2canvas: {
        scale: 2,
        useCORS: true,
        logging: false,
        backgroundColor: '#ffffff',
        allowTaint: true,
        onclone: function(clonedDoc) {
          // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
          const elements = clonedDoc.querySelectorAll('.dot-diagram-container, .katex-display, img, pre, table, blockquote');
          elements.forEach(el => {
            el.style.pageBreakInside = 'avoid';
            el.style.breakInside = 'avoid';
          });
        }
      },
      jsPDF: {
        unit: 'pt',
        format: 'a4',
        orientation: 'portrait'
      },
      pagebreak: {
        mode: ['avoid-all', 'css', 'legacy'],
        avoid: ['img', 'svg', '.katex-display', '.dot-diagram-container', 'pre', 'table', 'blockquote']
      }
    };
    
    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ PDF
    await html2pdf().set(options).from(clone).save();
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    downloadCount++;
    localStorage.setItem('downloadCount', downloadCount.toString());
    document.getElementById('statDownloads').textContent = downloadCount;
    
    showNotification(`–î–æ–∫—É–º–µ–Ω—Ç "${filename}.pdf" —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!`, 'success');
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ PDF:', error);
    showNotification(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
  } finally {
    // –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const tempContainers = document.querySelectorAll('div[style*="position: absolute"][style*="left: -9999px"]');
    tempContainers.forEach(container => {
      if (container.parentNode === document.body) {
        document.body.removeChild(container);
      }
    });
    
    pdfLoader.classList.remove('active');
  }
}

// ==================== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ====================
function showNotification(message, type = 'success', duration = 4000) {
  const notificationText = document.getElementById('notificationText');
  const icon = notification.querySelector('i');
  
  notificationText.textContent = message;
  notification.className = '';
  
  switch(type) {
    case 'success':
      notification.classList.add('show');
      notification.classList.add('success');
      icon.className = 'fas fa-check-circle success';
      break;
    case 'error':
      notification.classList.add('show');
      notification.classList.add('error');
      icon.className = 'fas fa-exclamation-circle error';
      break;
    case 'warning':
      notification.classList.add('show');
      notification.classList.add('warning');
      icon.className = 'fas fa-exclamation-triangle warning';
      break;
  }
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ
  if (duration > 0) {
    setTimeout(() => {
      notification.classList.remove('show');
    }, duration);
  }
}

function closeNotification() {
  notification.classList.remove('show');
}

// ==================== –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö ====================
window.addEventListener('error', (e) => {
  console.error('–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞:', e.error);
  if (e.error && e.error.message && !e.error.message.includes('ResizeObserver')) {
    showNotification(`–û—à–∏–±–∫–∞: ${e.error.message}`, 'error');
  }
});

window.addEventListener('unhandledrejection', (e) => {
  console.error('–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –ø—Ä–æ–º–∏—Å-–∏—Å–∫–ª—é—á–µ–Ω–∏–µ:', e.reason);
  if (e.reason && e.reason.message) {
    showNotification(`–û—à–∏–±–∫–∞: ${e.reason.message}`, 'error');
  }
});
</script>
</body>
</html>
